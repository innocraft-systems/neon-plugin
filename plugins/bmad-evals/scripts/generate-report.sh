#!/bin/bash

# BMAD-Evals Report Generator
# Generates comprehensive eval report with pass@k and pass^k metrics

set -euo pipefail

RESULTS_DIR="${1:-.claude/bmad-evals/results}"
OUTPUT_FILE="${2:-.claude/bmad-evals/eval-report.md}"

if [[ ! -d "$RESULTS_DIR" ]]; then
  echo ">>> No results directory found at $RESULTS_DIR" >&2
  exit 0
fi

# Collect all iteration results
ITERATIONS=$(ls "$RESULTS_DIR"/iteration-*.json 2>/dev/null | wc -l || echo "0")

if [[ "$ITERATIONS" -eq 0 ]]; then
  echo ">>> No iteration results found" >&2
  exit 0
fi

# Calculate metrics
TOTAL_ITERATIONS=$ITERATIONS
PASSED_ITERATIONS=0
FAILED_ITERATIONS=0

for result_file in "$RESULTS_DIR"/iteration-*.json; do
  if [[ -f "$result_file" ]]; then
    PASSED=$(jq -r '.graders_passed' "$result_file" 2>/dev/null || echo "false")
    if [[ "$PASSED" == "true" ]]; then
      PASSED_ITERATIONS=$((PASSED_ITERATIONS + 1))
    else
      FAILED_ITERATIONS=$((FAILED_ITERATIONS + 1))
    fi
  fi
done

# Calculate pass rate
if [[ $TOTAL_ITERATIONS -gt 0 ]]; then
  PASS_RATE=$(echo "scale=2; $PASSED_ITERATIONS * 100 / $TOTAL_ITERATIONS" | bc)
else
  PASS_RATE=0
fi

# Calculate pass@k (probability of at least 1 success in k trials)
# For k=1, pass@1 = pass_rate
PASS_AT_1=$PASS_RATE

# Calculate pass^k (probability of ALL k trials succeeding)
# pass^k = (pass_rate/100)^k
if [[ $TOTAL_ITERATIONS -gt 0 ]]; then
  PASS_POWER_K=$(echo "scale=4; ($PASS_RATE/100)^$TOTAL_ITERATIONS * 100" | bc 2>/dev/null || echo "0")
else
  PASS_POWER_K=0
fi

# Load state for task info
STATE_FILE=".claude/bmad-evals/eval-loop.state.json"
TASK_ID="unknown"
RUN_ID="unknown"
STARTED_AT="unknown"

if [[ -f "$STATE_FILE" ]]; then
  TASK_ID=$(jq -r '.current_task // "unknown"' "$STATE_FILE")
  RUN_ID=$(jq -r '.run_id // "unknown"' "$STATE_FILE")
  STARTED_AT=$(jq -r '.started_at // "unknown"' "$STATE_FILE")
fi

# Generate report
cat > "$OUTPUT_FILE" <<EOF
# BMAD-Evals Report

**Run ID:** $RUN_ID
**Task:** $TASK_ID
**Started:** $STARTED_AT
**Completed:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

---

## Summary Metrics

| Metric | Value |
|--------|-------|
| Total Iterations | $TOTAL_ITERATIONS |
| Passed Iterations | $PASSED_ITERATIONS |
| Failed Iterations | $FAILED_ITERATIONS |
| Pass Rate | ${PASS_RATE}% |
| pass@1 | ${PASS_AT_1}% |
| pass^$TOTAL_ITERATIONS | ${PASS_POWER_K}% |

---

## Iteration Details

EOF

# Add iteration details
for result_file in $(ls "$RESULTS_DIR"/iteration-*.json 2>/dev/null | sort -V); do
  if [[ -f "$result_file" ]]; then
    ITER=$(jq -r '.iteration' "$result_file")
    PASSED=$(jq -r '.graders_passed' "$result_file")
    TIMESTAMP=$(jq -r '.timestamp' "$result_file")

    if [[ "$PASSED" == "true" ]]; then
      STATUS="PASS"
    else
      STATUS="FAIL"
    fi

    echo "### Iteration $ITER - $STATUS" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
    echo "**Timestamp:** $TIMESTAMP" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"

    # Add grader details
    FAILED_GRADERS=$(jq -r '.grader_output.failed_graders // []' "$result_file" 2>/dev/null)
    if [[ "$FAILED_GRADERS" != "[]" ]] && [[ -n "$FAILED_GRADERS" ]]; then
      echo "**Failed Graders:**" >> "$OUTPUT_FILE"
      echo "$FAILED_GRADERS" | jq -r '.[] | "- " + .name + ": " + .message' >> "$OUTPUT_FILE" 2>/dev/null || true
      echo "" >> "$OUTPUT_FILE"
    fi

    PASSED_GRADERS=$(jq -r '.grader_output.passed_graders // []' "$result_file" 2>/dev/null)
    if [[ "$PASSED_GRADERS" != "[]" ]] && [[ -n "$PASSED_GRADERS" ]]; then
      echo "**Passed Graders:**" >> "$OUTPUT_FILE"
      echo "$PASSED_GRADERS" | jq -r '.[] | "- " + .name' >> "$OUTPUT_FILE" 2>/dev/null || true
      echo "" >> "$OUTPUT_FILE"
    fi

    echo "---" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
  fi
done

# Add recommendations section
cat >> "$OUTPUT_FILE" <<EOF

## Analysis

EOF

if [[ "$PASS_RATE" == "100" ]] || [[ "$PASS_RATE" == "100.00" ]]; then
  echo "All iterations passed. The task was completed successfully." >> "$OUTPUT_FILE"
elif [[ $(echo "$PASS_RATE > 80" | bc) -eq 1 ]]; then
  echo "High pass rate indicates reliable task completion with minor issues." >> "$OUTPUT_FILE"
elif [[ $(echo "$PASS_RATE > 50" | bc) -eq 1 ]]; then
  echo "Moderate pass rate suggests the task is achievable but needs refinement." >> "$OUTPUT_FILE"
else
  echo "Low pass rate indicates the task may need clearer success criteria or the agent needs more guidance." >> "$OUTPUT_FILE"
fi

echo "" >> "$OUTPUT_FILE"
echo "---" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"
echo "*Generated by BMAD-Evals Plugin*" >> "$OUTPUT_FILE"

echo ">>> BMAD-Evals report generated: $OUTPUT_FILE"
